<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Spark - What will you build today?</title>
  <!-- Version: 2.0.0 - Date Pills Feature -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#FFF7ED',
              100: '#FFEDD5',
              200: '#FED7AA',
              300: '#FDBA74',
              400: '#FB923C',
              500: '#F97316',
              600: '#EA580C',
              700: '#C2410C',
              800: '#9A3412',
              900: '#7C2D12',
            },
            surface: {
              50: '#FAFAF9',
              100: '#F5F5F4',
              200: '#E7E5E4',
            },
            warm: {
              dark: '#57534E',
              medium: '#78716C',
              light: '#A8A29E',
              lighter: '#D6D3D1',
              border: '#E7E5E4',
            },
            accent: '#F59E0B',
            success: '#16A34A',
            danger: '#DC2626',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .card-hover {
      transition: all 0.2s ease;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
    }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .line-clamp-none {
      display: block;
      -webkit-line-clamp: unset;
      -webkit-box-orient: unset;
      overflow: visible;
    }
    /* Hide scrollbar for date pills */
    .scrollbar-hide {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .scrollbar-hide::-webkit-scrollbar {
      display: none;
    }
    /* Date pill styles */
    .date-pill {
      background-color: #E7E5E4;
      color: #78716C;
    }
    .date-pill:hover {
      background-color: #D6D3D1;
    }
    .date-pill.active {
      background-color: #F97316;
      color: white;
    }
    /* Masonry grid - JavaScript positioned */
    .masonry-grid {
      position: relative;
      width: 100%;
    }
    .masonry-item {
      position: absolute;
      width: 100%;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    @media (min-width: 640px) {
      .masonry-item {
        width: calc(50% - 0.5rem);
      }
    }
    @media (min-width: 1024px) {
      .masonry-item {
        width: calc(33.333% - 0.667rem);
      }
    }
    /* Compact card styles */
    .compact-card {
      background: white;
      border-radius: 0;
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }
    .compact-card:hover {
      background: #FAFAF9;
    }
    /* Colored accent bar */
    .compact-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
    }
    .accent-coral::before { background: #F97316; }
    .accent-blue::before { background: #3B82F6; }
    .accent-green::before { background: #10B981; }
    .accent-purple::before { background: #8B5CF6; }
    .accent-pink::before { background: #EC4899; }
    .accent-yellow::before { background: #F59E0B; }
    .accent-teal::before { background: #14B8A6; }
    .accent-red::before { background: #EF4444; }
    /* Expandable description - height animation */
    .compact-card .description-truncated {
      display: block;
    }
    .compact-card .description-full {
      display: none;
    }
    .compact-card.expanded .description-truncated {
      display: none;
    }
    .compact-card.expanded .description-full {
      display: block;
    }
    /* Recipe pill styles (YouTube-like) */
    .recipe-pill {
      flex-shrink: 0;
      background-color: #F5F5F4;
      color: #57534E;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .recipe-pill:hover {
      background-color: #E7E5E4;
    }
    .recipe-pill.active {
      background-color: #1C1917;
      color: white;
    }
    .recipe-pill.special {
      background-color: #FFF7ED;
      color: #C2410C;
      border-color: #FDBA74;
    }
    .recipe-pill.special:hover {
      background-color: #FFEDD5;
    }
    .recipe-pill.special.active {
      background-color: #EA580C;
      color: white;
      border-color: #EA580C;
    }
    /* Hero section styles */
    .hero-section {
      position: relative;
      min-height: 320px;
      background-size: cover;
      background-position: center;
      transition: background-image 0.5s ease-in-out;
      overflow: hidden;
    }
    .hero-section::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.5) 100%);
    }
    .hero-content {
      position: relative;
      z-index: 10;
    }
    /* Recipe pills on hero - solid colors for dark background */
    .hero-recipe-pill {
      flex-shrink: 0;
      background-color: rgba(255, 255, 255, 0.9);
      color: #57534E;
      border: none;
      white-space: nowrap;
    }
    .hero-recipe-pill:hover {
      background-color: white;
    }
    .hero-recipe-pill.active {
      background-color: #1C1917;
      color: white;
    }
    .hero-recipe-pill.special {
      background-color: #F97316;
      color: white;
    }
    .hero-recipe-pill.special:hover {
      background-color: #EA580C;
    }
    .hero-recipe-pill.special.active {
      background-color: #C2410C;
      color: white;
    }
  </style>
</head>
<body class="bg-[#E8E6E3] min-h-screen">
  <!-- Hero Section with Dynamic Background -->
  <div id="heroSection" class="hero-section mb-8">
    <div class="hero-content container mx-auto px-4 py-8 max-w-6xl">
      <!-- Top bar with logo and recipes button -->
      <div class="flex items-center justify-between mb-6">
        <!-- Logo and name (top left) -->
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-lg bg-brand-500 flex items-center justify-center shadow">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
          </div>
          <h1 class="text-xl font-bold text-white drop-shadow">Spark</h1>
        </div>

        <!-- Recipes button (top right) -->
        <a href="/recipes.html" class="inline-flex items-center gap-1.5 text-sm font-medium text-gray-700 hover:text-gray-900 px-3 py-1.5 rounded-full bg-white hover:bg-gray-50 shadow-sm transition-all">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
          Recipes
        </a>
      </div>

      <!-- Recipe Pills (YouTube-style horizontal scroll) -->
      <div class="max-w-3xl mx-auto mb-6">
        <div class="relative">
          <div id="recipePillsContainer" class="flex gap-2 overflow-x-auto scrollbar-hide py-1 px-1 justify-center flex-wrap">
            <!-- Pills will be rendered here by JS -->
          </div>
        </div>
      </div>

      <!-- Adaptive Content Area -->
      <div class="max-w-3xl mx-auto">
        <div id="recipeContent" class="min-h-[100px]">
          <!-- Content changes based on selected recipe -->
        </div>
        <div id="fetchStatus" class="mt-4 text-sm font-medium text-center text-white"></div>
      </div>
    </div>
  </div>

  <!-- Ideas Section -->
  <div class="container mx-auto px-4 pb-12 max-w-6xl">
    <div id="ideasContainer" class="space-y-10">
      <!-- Ideas will be loaded here -->
    </div>

    <div id="loadingMore" class="hidden text-center py-10">
      <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-brand-200 border-t-brand-500"></div>
      <p class="mt-3 text-gray-500 font-medium">Loading more ideas...</p>
    </div>

    <div id="noMore" class="hidden text-center py-10">
      <p class="text-gray-400 font-medium">You've reached the end</p>
    </div>
  </div>

  <script>
    let availableDates = []; // All dates from database
    let allIdeas = []; // All ideas from all dates
    let isLoading = false;
    let currentImage = null; // Base64 image data
    let recipes = []; // All available recipes (from DB)
    let selectedRecipeId = 'producthunt'; // Currently selected recipe ID (string for built-in, number for user recipes)

    // Built-in special recipes (hero images will be loaded from R2)
    const BUILT_IN_RECIPES = [
      {
        id: 'producthunt',
        name: 'Product Hunt',
        type: 'producthunt',
        special: true,
        heroImageKey: 'producthunt' // Key to match in heroImages
      },
      {
        id: 'custom',
        name: 'Custom Input',
        type: 'custom',
        special: true,
        heroImageKey: 'custom' // Key to match in heroImages
      },
    ];

    // Hero images loaded from R2 (will be populated on init)
    let heroImages = [];

    // Fallback gradient if no images are available
    const FALLBACK_GRADIENT = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

    // DOM elements
    const heroSection = document.getElementById('heroSection');
    const recipePillsContainer = document.getElementById('recipePillsContainer');
    const recipeContent = document.getElementById('recipeContent');
    const fetchStatus = document.getElementById('fetchStatus');
    const ideasContainer = document.getElementById('ideasContainer');
    const loadingMore = document.getElementById('loadingMore');
    const noMore = document.getElementById('noMore');

    // Load hero images from R2
    async function loadHeroImages() {
      try {
        const response = await fetch('/api/hero-images');
        const data = await response.json();
        heroImages = data.data?.images || data.images || [];
      } catch (error) {
        console.error('Error loading hero images:', error);
        heroImages = [];
      }
    }

    // Get hero image URL for a recipe
    function getHeroImageUrl(recipeId) {
      const builtIn = BUILT_IN_RECIPES.find(r => r.id === recipeId);
      const userRecipe = recipes.find(r => r.id === recipeId);

      // 1. If user recipe has a custom background_image_url, use it
      if (userRecipe?.background_image_url) {
        return userRecipe.background_image_url;
      }

      // 2. Try to find matching image in R2 by name
      const keyToMatch = builtIn?.heroImageKey || (userRecipe ? `recipe-${userRecipe.id}` : null);
      if (keyToMatch) {
        const matchingImage = heroImages.find(img => img.name === keyToMatch);
        if (matchingImage) {
          return matchingImage.url;
        }
      }

      // 3. For user recipes without custom image, rotate through available hero images
      if (userRecipe && heroImages.length > 0) {
        const userRecipeIndex = recipes.findIndex(r => r.id === recipeId);
        // Filter to only "default" hero images (not recipe-specific ones)
        const defaultImages = heroImages.filter(img => !img.name.startsWith('recipe-'));
        if (defaultImages.length > 0) {
          return defaultImages[userRecipeIndex % defaultImages.length].url;
        }
        // Fallback to any image
        return heroImages[userRecipeIndex % heroImages.length].url;
      }

      // 4. Fallback - return null to use gradient
      return null;
    }

    // Update hero background based on selected recipe
    function updateHeroBackground() {
      const imageUrl = getHeroImageUrl(selectedRecipeId);

      if (imageUrl) {
        heroSection.style.backgroundImage = `url('${imageUrl}')`;
        heroSection.style.background = ''; // Clear any gradient
      } else {
        // Use fallback gradient
        heroSection.style.backgroundImage = 'none';
        heroSection.style.background = FALLBACK_GRADIENT;
      }
    }

    // Detect input type for custom input
    function detectInputType(text) {
      if (!text.trim() && currentImage) return 'image';
      if (!text.trim()) return 'empty';
      const urlPattern = /^(https?:\/\/|www\.)/i;
      if (urlPattern.test(text.trim())) return 'url';
      if (text.includes('producthunt.com')) return 'producthunt';
      return 'prompt';
    }

    // Render recipe pills
    function renderRecipePills() {
      recipePillsContainer.innerHTML = '';

      // Add built-in recipes first
      for (const recipe of BUILT_IN_RECIPES) {
        const pill = document.createElement('button');
        pill.className = `hero-recipe-pill special px-4 py-2 rounded-full text-sm font-medium transition-all ${selectedRecipeId === recipe.id ? 'active' : ''}`;
        pill.onclick = () => selectRecipe(recipe.id);
        pill.innerHTML = recipe.name;
        recipePillsContainer.appendChild(pill);
      }

      // Add user recipes
      for (const recipe of recipes) {
        const pill = document.createElement('button');
        pill.className = `hero-recipe-pill px-4 py-2 rounded-full text-sm font-medium transition-all ${selectedRecipeId === recipe.id ? 'active' : ''}`;
        pill.onclick = () => selectRecipe(recipe.id);
        pill.textContent = recipe.name;
        recipePillsContainer.appendChild(pill);
      }

      // Add "+" button to create new recipe
      const addPill = document.createElement('a');
      addPill.href = '/recipes.html';
      addPill.className = 'hero-recipe-pill px-3 py-2 rounded-full text-sm font-medium transition-all flex items-center gap-1';
      addPill.innerHTML = `
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
      `;
      recipePillsContainer.appendChild(addPill);
    }

    // Select a recipe and render its content
    function selectRecipe(recipeId) {
      selectedRecipeId = recipeId;
      renderRecipePills();
      renderRecipeContent();
      updateHeroBackground();
      fetchStatus.textContent = '';
    }

    // Render content area based on selected recipe
    function renderRecipeContent() {
      // Find the selected recipe
      const builtIn = BUILT_IN_RECIPES.find(r => r.id === selectedRecipeId);
      const userRecipe = recipes.find(r => r.id === selectedRecipeId);

      if (builtIn?.type === 'producthunt') {
        renderProductHuntContent();
      } else if (builtIn?.type === 'custom') {
        renderCustomInputContent();
      } else if (userRecipe) {
        renderUserRecipeContent(userRecipe);
      }
    }

    // Render Product Hunt content
    function renderProductHuntContent() {
      recipeContent.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
          <div class="w-14 h-14 mx-auto mb-3 rounded-full bg-[#FFF1EB] flex items-center justify-center">
            <svg class="w-7 h-7 text-[#DA552F]" fill="currentColor" viewBox="0 0 24 24"><path d="M13.604 8.4h-3.405V12h3.405c.995 0 1.801-.806 1.801-1.8 0-.995-.806-1.8-1.801-1.8zM12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm1.604 14.4h-3.405V18H7.801V6h5.804c2.319 0 4.2 1.881 4.2 4.2 0 2.319-1.881 4.2-4.201 4.2z"/></svg>
          </div>
          <p class="text-sm text-gray-600 mb-5">Generate ideas from today's top Product Hunt launches</p>
          <button
            id="generateBtn"
            onclick="generateFromSelectedRecipe()"
            class="bg-[#DA552F] hover:bg-[#C04B2A] text-white font-medium py-2.5 px-5 rounded-lg transition-all duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed inline-flex items-center gap-2"
          >
            <span id="generateBtnText">Get Today's Ideas</span>
            <svg id="generateSpinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </div>
      `;
    }

    // Render Custom Input content
    function renderCustomInputContent() {
      recipeContent.innerHTML = `
        <div
          id="smartInputContainer"
          class="bg-white rounded-xl shadow-lg focus-within:ring-2 focus-within:ring-brand-400 transition-all"
        >
          <div class="flex items-start gap-3 p-4">
            <div id="inputIcon" class="mt-1 text-gray-400">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <div class="flex-1">
              <textarea
                id="smartInput"
                placeholder="Paste a URL, describe an idea, or drop an image..."
                class="w-full resize-none border-0 bg-transparent text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-0 text-base leading-relaxed"
                rows="2"
              ></textarea>
              <div id="imagePreview" class="hidden mt-3">
                <div class="relative inline-block">
                  <img id="previewImg" class="max-h-32 rounded-lg" />
                  <button
                    id="removeImage"
                    onclick="removeImage()"
                    class="absolute -top-2 -right-2 w-6 h-6 bg-gray-800 text-white rounded-full flex items-center justify-center hover:bg-red-500 transition-colors"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="flex items-center justify-between px-4 py-3 border-t border-gray-100 bg-gray-50 rounded-b-xl">
            <div class="flex items-center gap-4 text-xs text-gray-500">
              <span id="inputTypeHint">Type or paste anything</span>
            </div>
            <div class="flex items-center gap-2">
              <label class="cursor-pointer text-gray-500 hover:text-brand-500 transition-colors p-2 rounded-lg hover:bg-brand-50">
                <input type="file" id="imageUpload" accept="image/*" class="hidden" onchange="handleImageUploadEvent(event)" />
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
              </label>
              <button
                id="generateBtn"
                onclick="generateFromSelectedRecipe()"
                class="bg-brand-500 hover:bg-brand-600 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed inline-flex items-center gap-2 text-sm"
              >
                <span id="generateBtnText">Generate</span>
                <svg id="generateSpinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;

      // Set up event listeners for the newly rendered elements
      setupCustomInputListeners();
    }

    // Render user recipe content
    function renderUserRecipeContent(recipe) {
      const hasPromptStyle = !!recipe.prompt_style;
      recipeContent.innerHTML = `
        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
          <h3 class="text-lg font-semibold text-gray-900 mb-1">${escapeHtml(recipe.name)}</h3>
          ${recipe.description ? `<p class="text-sm text-gray-600 mb-4">${escapeHtml(recipe.description)}</p>` : '<div class="mb-4"></div>'}
          ${recipe.prompt_style ? `<p class="text-xs text-gray-400 mb-5 italic max-w-md mx-auto">"${escapeHtml(recipe.prompt_style.substring(0, 100))}${recipe.prompt_style.length > 100 ? '...' : ''}"</p>` : '<p class="text-xs text-gray-400 mb-5 italic">No prompt style defined - <a href="/recipes.html" class="text-brand-500 hover:underline">edit recipe</a></p>'}
          <button
            id="generateBtn"
            onclick="generateFromSelectedRecipe()"
            class="bg-brand-500 hover:bg-brand-600 text-white font-medium py-2.5 px-5 rounded-lg transition-all duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed inline-flex items-center gap-2"
            ${!hasPromptStyle ? 'disabled' : ''}
          >
            <span id="generateBtnText">Generate Ideas</span>
            <svg id="generateSpinner" class="hidden w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </div>
      `;
    }

    // Setup event listeners for custom input (called after rendering)
    function setupCustomInputListeners() {
      const smartInput = document.getElementById('smartInput');
      const smartInputContainer = document.getElementById('smartInputContainer');

      if (smartInput) {
        smartInput.addEventListener('input', () => {
          updateInputHint();
          autoResize();
        });
        smartInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            generateFromSelectedRecipe();
          }
        });
        smartInput.addEventListener('paste', handlePaste);
      }

      if (smartInputContainer) {
        smartInputContainer.addEventListener('dragover', handleDragOver);
        smartInputContainer.addEventListener('dragleave', handleDragLeave);
        smartInputContainer.addEventListener('drop', handleDrop);
      }

      // Restore image if one was previously uploaded
      if (currentImage) {
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        if (imagePreview && previewImg) {
          previewImg.src = currentImage;
          imagePreview.classList.remove('hidden');
        }
      }

      updateInputHint();
    }

    // Generate from the selected recipe
    async function generateFromSelectedRecipe() {
      const btn = document.getElementById('generateBtn');
      const btnText = document.getElementById('generateBtnText');
      const btnSpinner = document.getElementById('generateSpinner');

      if (btn) btn.disabled = true;
      if (btnText) btnText.textContent = 'Generating...';
      if (btnSpinner) btnSpinner.classList.remove('hidden');
      fetchStatus.textContent = '';

      try {
        let response;

        if (selectedRecipeId === 'producthunt') {
          // Product Hunt
          const today = new Date().toISOString().split('T')[0];
          response = await fetch(`/api/fetch-ideas?date=${today}`, { method: 'POST' });
        } else if (selectedRecipeId === 'custom') {
          // Custom input
          const smartInput = document.getElementById('smartInput');
          const text = smartInput?.value.trim() || '';
          const type = detectInputType(text);

          if (type === 'empty') {
            fetchStatus.innerHTML = `<span class="text-[#DC2626]">Please enter a URL, prompt, or upload an image</span>`;
            if (btn) btn.disabled = false;
            if (btnText) btnText.textContent = 'Generate';
            if (btnSpinner) btnSpinner.classList.add('hidden');
            return;
          }

          if (type === 'url' || type === 'producthunt') {
            response = await fetch('/api/generate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type: 'url', url: text }),
            });
          } else if (type === 'image' || currentImage) {
            response = await fetch('/api/generate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type: 'image', image: currentImage, prompt: text }),
            });
          } else {
            response = await fetch('/api/generate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type: 'prompt', prompt: text }),
            });
          }
        } else {
          // User recipe
          response = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'recipe', recipe_id: selectedRecipeId }),
          });
        }

        const data = await response.json();

        if (data.success) {
          const count = data.data?.count || data.count || 0;
          const recipe = recipes.find(r => r.id === selectedRecipeId);
          const sourceName = selectedRecipeId === 'producthunt' ? 'Product Hunt' :
                            selectedRecipeId === 'custom' ? 'your input' :
                            recipe?.name || 'recipe';
          fetchStatus.innerHTML = `<span class="text-[#16A34A]">${count} new ideas from ${sourceName}!</span>`;

          // Clear custom input if used
          if (selectedRecipeId === 'custom') {
            const smartInput = document.getElementById('smartInput');
            if (smartInput) smartInput.value = '';
            removeImage();
            updateInputHint();
          }

          await loadAllIdeas();
        } else {
          const error = data.data?.error || data.error || 'Unknown error';
          fetchStatus.innerHTML = `<span class="text-[#DC2626]">Error: ${error}</span>`;
        }
      } catch (error) {
        fetchStatus.innerHTML = `<span class="text-[#DC2626]">Error: ${error.message}</span>`;
      } finally {
        if (btn) btn.disabled = false;
        const originalText = selectedRecipeId === 'producthunt' ? "Get Today's Ideas" :
                            selectedRecipeId === 'custom' ? 'Generate' : 'Generate Ideas';
        if (btnText) btnText.textContent = originalText;
        if (btnSpinner) btnSpinner.classList.add('hidden');
      }
    }

    // Update input hint for custom input
    function updateInputHint() {
      const smartInput = document.getElementById('smartInput');
      const inputIcon = document.getElementById('inputIcon');
      const inputTypeHint = document.getElementById('inputTypeHint');

      if (!smartInput || !inputIcon || !inputTypeHint) return;

      const type = detectInputType(smartInput.value);
      const icons = {
        empty: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>`,
        url: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>`,
        prompt: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>`,
        image: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>`,
        producthunt: `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M13.604 8.4h-3.405V12h3.405c.995 0 1.801-.806 1.801-1.8 0-.995-.806-1.8-1.801-1.8zM12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm1.604 14.4h-3.405V18H7.801V6h5.804c2.319 0 4.2 1.881 4.2 4.2 0 2.319-1.881 4.2-4.201 4.2z"/></svg>`,
      };
      const hints = {
        empty: 'Type or paste anything',
        url: 'URL detected - will analyze the page',
        prompt: 'Will generate ideas from your description',
        image: 'Image attached - will analyze for ideas',
        producthunt: 'Product Hunt link detected',
      };

      inputIcon.innerHTML = icons[type] || icons.empty;
      inputTypeHint.textContent = hints[type] || hints.empty;

      if (type === 'url' || type === 'producthunt') {
        inputIcon.classList.remove('text-gray-400');
        inputIcon.classList.add('text-brand-500');
      } else {
        inputIcon.classList.remove('text-brand-500');
        inputIcon.classList.add('text-gray-400');
      }
    }

    // Auto-resize textarea
    function autoResize() {
      const smartInput = document.getElementById('smartInput');
      if (!smartInput) return;
      smartInput.style.height = 'auto';
      smartInput.style.height = Math.min(smartInput.scrollHeight, 150) + 'px';
    }

    // Handle image upload event
    function handleImageUploadEvent(event) {
      const file = event.target.files?.[0];
      handleImageUpload(file);
    }

    // Handle image upload
    function handleImageUpload(file) {
      if (!file || !file.type.startsWith('image/')) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        currentImage = e.target.result;
        // Switch to custom input if not already there
        if (selectedRecipeId !== 'custom') {
          selectRecipe('custom');
        } else {
          // Update the preview in current view
          const imagePreview = document.getElementById('imagePreview');
          const previewImg = document.getElementById('previewImg');
          if (imagePreview && previewImg) {
            previewImg.src = currentImage;
            imagePreview.classList.remove('hidden');
          }
          updateInputHint();
        }
      };
      reader.readAsDataURL(file);
    }

    // Remove image
    function removeImage() {
      currentImage = null;
      const imagePreview = document.getElementById('imagePreview');
      const previewImg = document.getElementById('previewImg');
      if (imagePreview) imagePreview.classList.add('hidden');
      if (previewImg) previewImg.src = '';
      updateInputHint();
    }

    // Drag and drop handlers
    function handleDragOver(e) {
      e.preventDefault();
      const container = document.getElementById('smartInputContainer');
      if (container) container.classList.add('border-brand-400', 'bg-brand-50');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      const container = document.getElementById('smartInputContainer');
      if (container) container.classList.remove('border-brand-400', 'bg-brand-50');
    }

    function handleDrop(e) {
      e.preventDefault();
      const container = document.getElementById('smartInputContainer');
      if (container) container.classList.remove('border-brand-400', 'bg-brand-50');
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) {
        handleImageUpload(file);
      }
    }

    // Handle paste for images
    function handlePaste(e) {
      const items = e.clipboardData?.items;
      if (items) {
        for (const item of items) {
          if (item.type.startsWith('image/')) {
            e.preventDefault();
            const file = item.getAsFile();
            handleImageUpload(file);
            break;
          }
        }
      }
    }

    // Load all ideas from all dates
    async function loadAllIdeas() {
      if (isLoading) return;
      isLoading = true;
      loadingMore.classList.remove('hidden');

      try {
        // First get all available dates
        const datesResponse = await fetch('/api/dates');
        const datesData = await datesResponse.json();
        availableDates = datesData.data?.dates || datesData.dates || [];

        // Load ideas for all dates
        const response = await fetch('/api/ideas');
        const data = await response.json();
        const ideasData = data.data || data;

        // Flatten all ideas into a single array
        allIdeas = [];
        if (ideasData.ideas) {
          for (const date of Object.keys(ideasData.ideas).sort().reverse()) {
            for (const idea of ideasData.ideas[date]) {
              allIdeas.push({ ...idea, date });
            }
          }
        }

        renderAllIdeas();
      } catch (error) {
        console.error('Error loading ideas:', error);
        ideasContainer.innerHTML = '<p class="text-center text-gray-500">Error loading ideas.</p>';
      } finally {
        isLoading = false;
        loadingMore.classList.add('hidden');
      }
    }

    // Extract a short title (4-6 words) from a build idea description
    function extractTitle(buildIdea) {
      // Try to extract the product name if it follows pattern "ProductName - description"
      const dashMatch = buildIdea.match(/^([^-]+)\s*-/);
      if (dashMatch && dashMatch[1].split(' ').length <= 6) {
        return dashMatch[1].trim();
      }

      // Otherwise take first 4-6 words
      const words = buildIdea.split(' ');
      const titleWords = words.slice(0, Math.min(6, words.length));
      let title = titleWords.join(' ');

      // Clean up - remove trailing punctuation and add ellipsis if truncated
      title = title.replace(/[,.:;]$/, '');
      if (words.length > 6) {
        title += '...';
      }

      return title;
    }

    function renderAllIdeas() {
      ideasContainer.innerHTML = '';

      if (allIdeas.length === 0) {
        ideasContainer.innerHTML = '<p class="text-center text-gray-500">No ideas yet. Click "Get today\'s ideas" to start!</p>';
        return;
      }

      // Flatten: create one card per build idea (not per product)
      const buildIdeaCards = [];

      for (const product of allIdeas) {
        // Parse mini ideas
        let miniIdeas = [];
        try {
          if (product.mini_ideas && Array.isArray(product.mini_ideas)) {
            miniIdeas = product.mini_ideas;
          } else if (product.mini_idea) {
            if (typeof product.mini_idea === 'string' && product.mini_idea.startsWith('[')) {
              miniIdeas = JSON.parse(product.mini_idea);
            } else {
              miniIdeas = [product.mini_idea];
            }
          }
        } catch (error) {
          console.error('Error parsing mini ideas:', error, product);
        }

        // Parse title summaries
        let titleSummaries = [];
        try {
          if (product.title_summaries && Array.isArray(product.title_summaries)) {
            titleSummaries = product.title_summaries;
          } else if (product.title_summaries && typeof product.title_summaries === 'string' && product.title_summaries.startsWith('[')) {
            titleSummaries = JSON.parse(product.title_summaries);
          }
        } catch (error) {
          console.error('Error parsing title summaries:', error, product);
        }

        // Create a card for each build idea
        for (let idx = 0; idx < miniIdeas.length; idx++) {
          // Get title from database title_summaries if available
          const dbTitle = titleSummaries[idx];
          buildIdeaCards.push({
            buildIdea: miniIdeas[idx],
            buildIdeaIndex: idx,
            titleSummary: (dbTitle !== undefined && dbTitle !== null && dbTitle !== '') ? dbTitle : null, // Use database title if it exists and is not empty
            product: product
          });
        }
      }

      if (buildIdeaCards.length === 0) {
        ideasContainer.innerHTML = '<p class="text-center text-gray-500">No build ideas yet. Click "Get today\'s ideas" to start!</p>';
        return;
      }

      // Masonry grid container
      const ideasGrid = document.createElement('div');
      ideasGrid.className = 'masonry-grid';

      // Accent color classes for variety
      const accentColors = ['accent-coral', 'accent-blue', 'accent-green', 'accent-purple', 'accent-pink', 'accent-yellow', 'accent-teal', 'accent-red'];

      for (let i = 0; i < buildIdeaCards.length; i++) {
        const { buildIdea, buildIdeaIndex, titleSummary, product } = buildIdeaCards[i];
        // Use title_summary from database if available
        const title = (titleSummary !== null && titleSummary !== undefined) ? titleSummary : extractTitle(buildIdea);

        // Truncate description with MORE variation (12-50 words for masonry effect)
        const words = buildIdea.split(' ');
        // Use a more varied pattern: some very short, some medium, some long
        const variationPatterns = [12, 15, 20, 12, 35, 18, 50, 14, 25, 12, 40, 16, 30, 13, 45, 17];
        const truncateLength = variationPatterns[i % variationPatterns.length];
        const needsTruncation = words.length > truncateLength;
        const truncatedText = needsTruncation
          ? words.slice(0, truncateLength).join(' ') + '...'
          : buildIdea;

        // Assign accent color based on index
        const accentClass = accentColors[i % accentColors.length];

        // Masonry item wrapper
        const masonryItem = document.createElement('div');
        masonryItem.className = 'masonry-item';

        const ideaCard = document.createElement('div');
        ideaCard.className = `compact-card ${accentClass}`;
        ideaCard.onclick = function(e) {
          // Don't toggle if clicking on a link
          if (e.target.tagName === 'A' || e.target.closest('a')) return;
          this.classList.toggle('expanded');
          // Re-layout masonry after card height changes
          requestAnimationFrame(() => {
            layoutMasonry();
          });
        };

        ideaCard.innerHTML = `
          <div class="p-5 pl-6">
            <!-- Title -->
            <h3 class="text-lg font-normal text-[#1C1917] leading-tight mb-2">${escapeHtml(title)}</h3>

            <!-- Description -->
            <p class="description-truncated text-sm text-[#78716C] leading-relaxed">${escapeHtml(truncatedText)}</p>
            <p class="description-full text-sm text-[#78716C] leading-relaxed">${escapeHtml(buildIdea)}</p>

            <!-- Footer: Inspired by + Date -->
            <div class="mt-4 flex items-center justify-between">
              <a href="${product.ph_url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-xs text-[#78716C] hover:text-brand-600 transition-colors" onclick="event.stopPropagation()">
                ${product.ph_image ? `
                  <img src="${escapeHtml(product.ph_image)}" alt="${escapeHtml(product.ph_name)}" class="w-6 h-6 rounded object-cover" />
                ` : `
                  <div class="w-6 h-6 rounded bg-brand-100 flex items-center justify-center">
                    <svg class="w-3 h-3 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                  </div>
                `}
                <span>${escapeHtml(product.ph_name)}</span>
              </a>
              <span class="text-xs text-[#A8A29E]">${new Date(product.date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
            </div>
          </div>
        `;

        masonryItem.appendChild(ideaCard);
        ideasGrid.appendChild(masonryItem);
      }

      ideasContainer.appendChild(ideasGrid);

      // Layout masonry after DOM is ready
      requestAnimationFrame(() => {
        layoutMasonry();
      });
    }

    function toggleReadMore(btn) {
      const textEl = btn.previousElementSibling;
      const isExpanded = textEl.classList.contains('line-clamp-none');

      if (isExpanded) {
        textEl.classList.remove('line-clamp-none');
        textEl.classList.add('line-clamp-3');
        btn.textContent = 'Read more';
      } else {
        textEl.classList.remove('line-clamp-3');
        textEl.classList.add('line-clamp-none');
        btn.textContent = 'Show less';
      }

      // Re-layout masonry after card height change
      requestAnimationFrame(() => {
        layoutMasonry();
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Masonry layout - positions items in columns, filling shortest column first
    // This maintains left-to-right, top-to-bottom order (newest first)
    function layoutMasonry() {
      const grid = document.querySelector('.masonry-grid');
      if (!grid) return;

      const items = grid.querySelectorAll('.masonry-item');
      if (items.length === 0) return;

      const gap = 16; // 1rem gap
      const gridWidth = grid.offsetWidth;

      // Determine number of columns based on viewport
      let numCols = 1;
      if (window.innerWidth >= 1024) numCols = 3;
      else if (window.innerWidth >= 640) numCols = 2;

      const colWidth = (gridWidth - (numCols - 1) * gap) / numCols;
      const colHeights = new Array(numCols).fill(0);

      items.forEach((item, index) => {
        // Find the shortest column
        const shortestCol = colHeights.indexOf(Math.min(...colHeights));

        // Position the item
        const x = shortestCol * (colWidth + gap);
        const y = colHeights[shortestCol];

        item.style.transform = `translate(${x}px, ${y}px)`;
        item.style.width = `${colWidth}px`;

        // Update column height
        colHeights[shortestCol] += item.offsetHeight + gap;
      });

      // Set grid container height
      grid.style.height = `${Math.max(...colHeights)}px`;
    }

    // Debounced resize handler
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(layoutMasonry, 100);
    });

    function updateDatePills() {
      console.log('updateDatePills called, availableDates:', availableDates); // Debug
      const datePillsContainer = document.getElementById('datePillsContainer');
      const datePills = document.getElementById('datePills');

      // Clear existing pills
      datePills.innerHTML = '';

      if (availableDates.length === 0) {
        datePillsContainer.style.display = 'none';
        return;
      }

      // Show pills container
      datePillsContainer.style.display = 'block';
      console.log('Pills container should be visible now'); // Debug

      // Create a pill for each date
      for (const date of availableDates) {
        const dateObj = new Date(date + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

        const pill = document.createElement('button');
        pill.className = `date-pill flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all duration-200`;
        pill.textContent = formattedDate;
        // Date pills are for display only - all ideas are shown together

        datePills.appendChild(pill);
        console.log('Added pill for date:', date, formattedDate); // Debug
      }
    }

    async function refreshIdeas(ideaId, button) {
      if (!ideaId) {
        alert('Error: Idea ID not found');
        return;
      }

      const refreshIcon = document.getElementById(`refresh-icon-${ideaId}`);
      const refreshText = document.getElementById(`refresh-text-${ideaId}`);
      const refreshSpinner = document.getElementById(`refresh-spinner-${ideaId}`);

      // Disable button and show loading state
      button.disabled = true;
      if (refreshIcon) refreshIcon.classList.add('hidden');
      if (refreshText) refreshText.textContent = 'Refreshing...';
      if (refreshSpinner) refreshSpinner.classList.remove('hidden');

      try {
        const response = await fetch(`/api/ideas/${ideaId}/refresh`, {
          method: 'POST',
        });

        const data = await response.json();

        if (data.success || (data.data && data.data.mini_ideas)) {
          // Handle both old and new response formats
          const newMiniIdeas = data.data?.mini_ideas || data.mini_ideas || [];

          // Handle both old and new response formats
          const newTitleSummaries = data.data?.title_summaries || [];
          
          // Update the idea in allIdeas array
          const ideaIndex = allIdeas.findIndex(idea => idea.id === ideaId);
          if (ideaIndex !== -1) {
            allIdeas[ideaIndex].mini_ideas = newMiniIdeas;
            if (newTitleSummaries.length > 0) {
              allIdeas[ideaIndex].title_summaries = newTitleSummaries;
            }
            // Re-render all ideas
            renderAllIdeas();
          }
        } else {
          const error = data.data?.error || data.error || 'Unknown error';
          alert(`Error refreshing ideas: ${error}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      } finally {
        // Re-enable button and restore state
        button.disabled = false;
        if (refreshIcon) refreshIcon.classList.remove('hidden');
        if (refreshText) refreshText.textContent = 'Refresh';
        if (refreshSpinner) refreshSpinner.classList.add('hidden');
      }
    }

    async function clearDate(date) {
      // Parse date as local time to avoid timezone issues
      if (!confirm(`Are you sure you want to delete all ideas from ${new Date(date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/ideas/${date}`, {
          method: 'DELETE',
        });

        const data = await response.json();

        if (data.success) {
          // Reload all ideas after deletion
          await loadAllIdeas();
        } else {
          const error = data.data?.error || data.error || 'Unknown error';
          alert(`Error: ${error}`);
        }
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }

    // Load recipes from API
    async function loadRecipes() {
      try {
        const response = await fetch('/api/recipes');
        const data = await response.json();
        recipes = data.data || data || [];
        renderRecipePills();
        renderRecipeContent();
        updateHeroBackground(); // Update in case recipe has custom background_image_url
      } catch (error) {
        console.error('Error loading recipes:', error);
      }
    }

    // Initialize the UI
    async function initializeUI() {
      // Load hero images first, then render
      await loadHeroImages();
      renderRecipePills();
      renderRecipeContent();
      updateHeroBackground();
      loadAllIdeas();
      loadRecipes();
    }

    // Start the app
    initializeUI();
  </script>
</body>
</html>

